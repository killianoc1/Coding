#include <stm32f031x6.h>
#include "display.h"
#include <stdlib.h>
#include <time.h>
#include <stdbool.h>
#include <unistd.h>
void initClock(void);
void initSysTick(void);
void SysTick_Handler(void);
void delay(volatile uint32_t dly);
void setupIO();
int isInside(uint16_t x1, uint16_t y1, uint16_t w, uint16_t h, uint16_t px, uint16_t py);
void enablePullUp(GPIO_TypeDef *Port, uint32_t BitNumber);
void pinMode(GPIO_TypeDef *Port, uint32_t BitNumber, uint32_t Mode);
void RockGen(uint16_t xRange, uint16_t yRange, uint16_t width, uint16_t height, const uint16_t rock[], uint16_t snailX, uint16_t snailY, uint16_t snailW, uint16_t snailH);
volatile uint32_t milliseconds;

bool coin_collected = false;
bool rock_hit = false;


const uint16_t Snail1[]=
{
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,65535,58466,0,65535,58466,0,0,0,0,0,0,0,0,0,0,0,65535,65535,0,65535,65535,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2296,2296,2296,2296,2296,2296,0,0,0,0,0,0,0,0,0,7928,7928,7928,7928,7928,7928,2296,2296,0,0,0,48902,19714,0,0,7928,7928,2296,2296,2296,2296,7928,7928,2296,2296,0,48902,48902,19714,0,0,7928,2296,2296,7928,7928,7928,2296,7928,7928,2296,0,48902,48902,19714,0,0,2296,2296,7928,7928,7928,7928,7928,2296,7928,2296,48902,48902,19714,0,0,0,2296,7928,7928,2296,7928,7928,7928,2296,7928,2296,48902,48902,19714,0,0,0,2296,7928,7928,2296,2296,2296,2296,7928,7928,2296,48902,48902,19714,0,0,0,2296,2296,7928,7928,7928,2296,7928,7928,7928,2296,48902,48902,0,0,0,0,0,2296,2296,7928,7928,7928,7928,7928,2296,48902,48902,48902,0,0,0,0,0,48902,2296,2296,2296,2296,2296,2296,19714,19714,19714,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,

};
const uint16_t Snail2[]= 
    {
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,65535,58466,0,65535,58466,0,0,0,0,0,0,0,0,0,0,0,65535,65535,0,65535,65535,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7928,7928,7928,7928,7928,7928,0,0,0,0,19714,48902,0,0,0,7928,2296,2296,2296,2296,7928,7928,7928,0,0,0,19714,48902,0,0,0,2296,2296,7928,7928,2296,2296,7928,7928,2296,0,0,19714,48902,0,0,0,7928,7928,7928,7928,7928,2296,2296,7928,2296,19714,19714,48902,48902,0,0,0,7928,7928,2296,7928,7928,7928,2296,7928,2296,48902,48902,48902,48902,0,0,0,7928,7928,7928,2296,7928,2296,7928,7928,2296,48902,48902,48902,48902,0,0,0,2296,2296,7928,7928,2296,7928,7928,2296,2296,48902,48902,48902,19714,0,0,0,0,2296,2296,7928,7928,7928,2296,2296,48902,48902,48902,48902,0,0,0,0,0,0,2296,2296,2296,2296,2296,19714,19714,19714,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    };
const uint16_t rock[]=
{
    0,0,0,0,58136,58136,58136,58136,58136,58136,0,0,0,0,0,0,0,0,0,58136,35410,35410,35410,35410,35410,36203,58136,0,0,0,0,0,0,0,58136,35410,35410,35410,36203,36203,36203,36203,36203,58136,0,0,0,0,0,58136,35410,35410,35410,36203,36203,36203,36203,36203,36203,12948,58136,0,0,0,0,58136,35410,36203,36203,36203,36203,36203,36203,36203,12948,12948,12948,58136,0,0,0,58136,35410,36203,36203,36203,36203,36203,36203,36203,12948,12948,12948,12948,58136,0,58136,35410,35410,36203,36203,36203,36203,36203,36203,36203,12948,12948,12948,12948,36203,58136,58136,35410,35410,36203,36203,36203,36203,36203,36203,36203,36203,12948,12948,12948,36203,58136,58136,35410,35410,36203,36203,36203,36203,36203,36203,36203,36203,36203,12948,36203,36203,58136,58136,35410,35410,36203,36203,36203,36203,36203,36203,36203,36203,36203,36203,36203,36203,58136,0,58136,35410,35410,36203,36203,36203,36203,36203,36203,36203,36203,36203,36203,36203,58136,0,58136,35410,35410,35410,36203,36203,36203,36203,36203,36203,36203,36203,36203,58136,0,0,0,58136,35410,35410,35410,36203,36203,36203,36203,36203,36203,36203,36203,58136,0,0,0,0,58136,35410,35410,35410,36203,36203,36203,36203,36203,36203,58136,0,0,0,0,0,58136,58136,35410,35410,35410,35410,35410,58136,58136,58136,0,0,0,0,0,0,0,0,58136,58136,58136,58136,58136,0,0,0,0,0,0,
};
const uint16_t heart[]=
{
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,65315,65315,65315,0,0,0,65315,65315,65315,0,0,0,0,0,0,65315,40224,40224,40224,65315,0,65315,40224,40224,40224,65315,0,0,0,0,65315,40224,40224,40224,40224,40224,65315,40224,40224,40224,40224,40224,65315,0,0,0,65315,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,65315,0,0,0,65315,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,65315,0,0,0,65315,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,65315,0,0,0,65315,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,65315,0,0,0,0,65315,40224,40224,40224,40224,40224,40224,40224,40224,40224,65315,0,0,0,0,0,0,65315,40224,40224,40224,40224,40224,40224,40224,65315,0,0,0,0,0,0,0,0,65315,40224,40224,40224,40224,40224,65315,0,0,0,0,0,0,0,0,0,0,65315,40224,40224,40224,65315,0,0,0,0,0,0,0,0,0,0,0,0,65315,65315,65315,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
};

const uint16_t coin[]={
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,65382,65382,65382,65382,65382,65382,0,0,0,0,0,0,0,0,65382,65382,64293,64293,64293,64293,64293,64293,64293,57093,0,0,0,0,0,65382,64293,64293,57093,57093,57093,57093,57093,57093,57093,57093,57093,0,0,0,65382,64293,57093,57093,57093,64293,64293,64293,64293,65382,57093,57093,65382,57093,0,0,65382,64293,57093,57093,64293,57093,65382,57093,57093,64293,65382,57093,65382,57093,0,0,65382,64293,57093,64293,57093,65382,57093,57093,57093,57093,64293,57093,57093,57093,0,0,65382,64293,57093,64293,57093,65382,57093,57093,57093,57093,64293,57093,57093,57093,0,0,65382,64293,57093,64293,57093,65382,57093,57093,65382,57093,64293,57093,57093,57093,0,0,65382,64293,57093,64293,57093,65382,57093,57093,65382,57093,64293,57093,57093,57093,0,0,65382,57093,57093,57093,64293,57093,57093,65382,57093,64293,57093,57093,57093,57093,0,0,65382,57093,57093,57093,57093,64293,64293,64293,64293,57093,57093,57093,65382,64293,0,0,0,57093,57093,57093,57093,57093,57093,57093,57093,57093,57093,64293,64293,0,0,0,0,0,0,65382,57093,57093,57093,57093,65382,65382,64293,0,0,0,0,0,0,0,0,0,65382,57093,57093,64293,64293,64293,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
};

const uint16_t start1[]={
27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,48161,48161,48161,48161,0,0,0,0,0,0,0,0,0,48161,48161,0,0,0,0,0,0,0,0,0,48161,48161,48161,48161,48161,48161,0,0,48161,48161,48161,48161,48161,48161,0,0,0,0,0,48161,48161,48161,48161,48161,0,0,0,0,0,0,0,0,0,48161,27849,27849,48161,48161,48161,48161,0,14831,14831,14831,14831,14831,14831,14831,0,48161,48161,0,14831,14831,14831,14831,14831,14831,14831,0,48161,48161,48161,48161,48161,0,14831,14831,0,48161,48161,48161,48161,48161,0,14831,14831,14831,14831,0,48161,48161,48161,48161,0,14831,14831,14831,14831,14831,14831,14831,0,48161,27849,27849,48161,48161,48161,48161,0,14831,0,0,0,0,0,0,0,48161,48161,0,0,0,0,14831,0,0,0,0,48161,48161,48161,48161,0,14831,14831,14831,14831,0,48161,48161,48161,48161,0,14831,0,0,14831,14831,0,48161,48161,48161,0,0,0,0,14831,0,0,0,0,48161,27849,27849,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,48161,0,14831,14831,0,0,14831,14831,0,48161,48161,48161,0,14831,0,48161,0,14831,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,27849,27849,48161,48161,48161,48161,0,14831,0,0,0,0,0,0,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,14831,0,48161,48161,0,14831,14831,0,48161,48161,0,14831,0,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,27849,27849,48161,48161,48161,48161,0,14831,14831,14831,14831,14831,14831,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,0,14831,0,48161,48161,0,14831,0,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,27849,27849,48161,48161,48161,48161,0,0,0,0,0,0,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,0,14831,0,48161,48161,0,14831,0,48161,0,14831,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,27849,27849,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,0,0,0,0,0,14831,0,48161,48161,0,14831,0,0,14831,14831,0,48161,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,27849,27849,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,14831,14831,14831,14831,14831,14831,14831,0,48161,48161,0,14831,14831,14831,14831,0,48161,48161,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,27849,27849,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,0,0,0,0,0,14831,0,48161,48161,0,14831,14831,14831,14831,0,48161,48161,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,27849,27849,48161,48161,48161,48161,0,0,0,0,0,0,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,0,14831,0,48161,48161,0,14831,0,0,14831,14831,0,48161,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,27849,27849,48161,48161,48161,48161,0,14831,14831,14831,14831,14831,14831,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,0,14831,0,48161,48161,0,14831,0,48161,0,14831,14831,0,48161,48161,48161,48161,48161,0,14831,0,48161,48161,48161,48161,27849,27849,48161,48161,48161,48161,0,0,0,0,0,0,0,0,0,48161,48161,48161,48161,48161,0,0,0,48161,48161,48161,48161,48161,0,0,0,48161,48161,48161,48161,0,0,0,48161,48161,0,0,0,48161,48161,0,0,0,48161,48161,48161,48161,48161,0,0,0,48161,48161,48161,48161,27849,27849,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,
};

const uint16_t start2[]={
48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,27849,27849,27849,27849,0,0,0,0,0,0,0,0,0,27849,27849,0,0,0,0,0,0,0,0,0,27849,27849,27849,27849,27849,27849,0,0,27849,27849,27849,27849,27849,27849,0,0,0,0,0,27849,27849,27849,27849,27849,0,0,0,0,0,0,0,0,0,27849,48161,48161,27849,27849,27849,27849,0,14831,14831,14831,14831,14831,14831,14831,0,27849,27849,0,14831,14831,14831,14831,14831,14831,14831,0,27849,27849,27849,27849,27849,0,14831,14831,0,27849,27849,27849,27849,27849,0,14831,14831,14831,14831,0,27849,27849,27849,27849,0,14831,14831,14831,14831,14831,14831,14831,0,27849,48161,48161,27849,27849,27849,27849,0,14831,0,0,0,0,0,0,0,27849,27849,0,0,0,0,14831,0,0,0,0,27849,27849,27849,27849,0,14831,14831,14831,14831,0,27849,27849,27849,27849,0,14831,0,0,14831,14831,0,27849,27849,27849,0,0,0,0,14831,0,0,0,0,27849,48161,48161,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,27849,0,14831,14831,0,0,14831,14831,0,27849,27849,27849,0,14831,0,27849,0,14831,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,48161,48161,27849,27849,27849,27849,0,14831,0,0,0,0,0,0,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,14831,0,27849,27849,0,14831,14831,0,27849,27849,0,14831,0,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,48161,48161,27849,27849,27849,27849,0,14831,14831,14831,14831,14831,14831,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,0,14831,0,27849,27849,0,14831,0,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,48161,48161,27849,27849,27849,27849,0,0,0,0,0,0,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,0,14831,0,27849,27849,0,14831,0,27849,0,14831,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,48161,48161,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,0,0,0,0,0,14831,0,27849,27849,0,14831,0,0,14831,14831,0,27849,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,48161,48161,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,14831,14831,14831,14831,14831,14831,14831,0,27849,27849,0,14831,14831,14831,14831,0,27849,27849,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,48161,48161,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,0,0,0,0,0,14831,0,27849,27849,0,14831,14831,14831,14831,0,27849,27849,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,48161,48161,27849,27849,27849,27849,0,0,0,0,0,0,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,0,14831,0,27849,27849,0,14831,0,0,14831,14831,0,27849,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,48161,48161,27849,27849,27849,27849,0,14831,14831,14831,14831,14831,14831,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,0,14831,0,27849,27849,0,14831,0,27849,0,14831,14831,0,27849,27849,27849,27849,27849,0,14831,0,27849,27849,27849,27849,48161,48161,27849,27849,27849,27849,0,0,0,0,0,0,0,0,0,27849,27849,27849,27849,27849,0,0,0,27849,27849,27849,27849,27849,0,0,0,27849,27849,27849,27849,0,0,0,27849,27849,0,0,0,27849,27849,0,0,0,27849,27849,27849,27849,27849,0,0,0,27849,27849,27849,27849,48161,48161,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,27849,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,48161,
};

const uint16_t finish1[]={
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,65535,65535,65535,65535,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,65535,65535,65535,65535,65535,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,65535,65535,65535,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,65535,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,65535,65535,65535,65535,40224,40224,40224,65535,40224,40224,40224,65535,40224,40224,40224,65535,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,65535,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,65535,65535,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,65535,65535,65535,65535,65535,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,40224,40224,40224,65535,40224,40224,65535,40224,40224,65535,65535,65535,65535,65535,65535,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,65535,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,40224,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
};
const uint16_t finish2[]={
9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,65535,65535,65535,65535,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,65535,65535,65535,65535,65535,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,65535,65535,65535,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,65535,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,65535,65535,65535,65535,24817,24817,24817,65535,24817,24817,24817,65535,24817,24817,24817,65535,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,65535,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,65535,65535,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,65535,65535,65535,65535,65535,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,24817,24817,24817,65535,24817,24817,65535,24817,24817,65535,65535,65535,65535,65535,65535,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,65535,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,24817,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,9293,
};

int lives = 3;
int coinCount = 0;

int main()
{
    
    uint16_t x = 50;
    uint16_t y = 130;
    uint16_t oldx = x;
    uint16_t oldy = y;
    int hinverted = 0;
    int vinverted = 0;
    int toggle = 0;
    int hmoved = 0;
    int vmoved = 0;
    volatile uint32_t rock_timer = 0;
    volatile uint32_t coin_timer = 0;
    uint16_t snailW = 16;  // Snail's width
    uint16_t snailH = 16;  // Snail's heigh

    initClock();
    initSysTick();
    setupIO();
    srand(time(0));  

    menu(); //call menu once before game begins

    while (1) {
 
        char text[50]; 
        snprintf(text, sizeof(text), "Coins: %d", coinCount); //printing the coin counter 
        printTextX2(text, 8, 14, RGBToWord(0xff, 0x00, 0x00), 0); 

        if (milliseconds - rock_timer >= 1000) {  
            RockGen(128, 160, 16, 16, rock, x, y, snailW, snailH);
            rock_timer = milliseconds;  
        }

        if (milliseconds - coin_timer >= 1500) {  
            coinGen(coinCount, x, y, snailW, snailH);
            coin_timer = milliseconds;  // Reset coin timer
        }


            // Call RockGen to handle the falling rock
            RockGen(128, 160, 16, 16, rock, x, y, snailH, snailW);
            coinGen(coinCount, x, y, snailH, snailW);

            if(coinCount == 15){
                fillRectangle(0,0,128,160,0); //remove all sprites from screen
                printTextX2("YOU WIN", 15, 50, RGBToWord(0x00, 0xff, 0x00), 0); 
                delay(1500);
                menu(); //go back to main menu
            }

            hmoved = vmoved = 0;
            hinverted = vinverted = 0;
        // After calling RockGen and coinGen
            coin_collected = false;
            rock_hit = false;


            // SNAIL MOVEMENT
            if ((GPIOB->IDR & (1 << 4)) == 0) {  // Right button pressed
                if (x < 110) {
                    x = x + 6;
                    hmoved = 1;
                    hinverted = 0;
                }
            }
            if ((GPIOB->IDR & (1 << 5)) == 0) {  // Left button pressed
                if (x > 10) {
                    x = x - 6;
                    hmoved = 1;
                    hinverted = 1;
                }
            }

            // Redraw snail after it moves
            if (hmoved || vmoved) {
                fillRectangle(oldx, oldy, 16, 16, 0);  // Clear old position
                oldx = x;
                oldy = y;

        
                if (toggle) {
                    putImage(x, y, 16, 16, Snail1, hinverted, 0);
                } else {
                    putImage(x, y, 16, 16, Snail2, hinverted, 0);
                }
                toggle = !toggle;
            }
        }
}

void initSysTick(void)
{
    SysTick->LOAD = 48000;
    SysTick->CTRL = 7;
    SysTick->VAL = 10;
    __asm(" cpsie i "); 
}
void SysTick_Handler(void)
{
    milliseconds++;
}
void initClock(void)
{
// This is potentially a dangerous function as it could
// result in a system with an invalid clock signal - result: a stuck system
        // Set the PLL up
        // First ensure PLL is disabled
        RCC->CR &= ~(1u<<24);
        while( (RCC->CR & (1 <<25))); // wait for PLL ready to be cleared
        
// Warning here: if system clock is greater than 24MHz then wait-state(s) need to be
// inserted into Flash memory interface
                
        FLASH->ACR |= (1 << 0);
        FLASH->ACR &=~((1u << 2) | (1u<<1));
        // Turn on FLASH prefetch buffer
        FLASH->ACR |= (1 << 4);
        // set PLL multiplier to 12 (yielding 48MHz)
        RCC->CFGR &= ~((1u<<21) | (1u<<20) | (1u<<19) | (1u<<18));
        RCC->CFGR |= ((1<<21) | (1<<19) ); 

        // Need to limit ADC clock to below 14MHz so will change ADC prescaler to 4
        RCC->CFGR |= (1<<14);

        // and turn the PLL back on again
        RCC->CR |= (1<<24);        
        // set PLL as system clock source 
        RCC->CFGR |= (1<<1);
}

void delay(volatile uint32_t dly)
{
    uint32_t end_time = dly + milliseconds;
    while(milliseconds != end_time)
        __asm(" wfi "); // sleep
}

void enablePullUp(GPIO_TypeDef *Port, uint32_t BitNumber)
{
    Port->PUPDR = Port->PUPDR &~(3u << BitNumber*2); // clear pull-up resistor bits
    Port->PUPDR = Port->PUPDR | (1u << BitNumber*2); // set pull-up bit
}

void pinMode(GPIO_TypeDef *Port, uint32_t BitNumber, uint32_t Mode)
{
    
    uint32_t mode_value = Port->MODER;
    Mode = Mode << (2 * BitNumber);
    mode_value = mode_value & ~(3u << (BitNumber * 2));
    mode_value = mode_value | Mode;
    Port->MODER = mode_value;
}

int isInside(uint16_t x1, uint16_t y1, uint16_t w, uint16_t h, uint16_t px, uint16_t py)
{
    // checks to see if point px,py is within the rectange defined by x,y,w,h
    uint16_t x2,y2;
    x2 = x1+w;
    y2 = y1+h;
    int rvalue = 0;
    if ( (px >= x1) && (px <= x2))
    {
        // ok, x constraint met
        if ( (py >= y1) && (py <= y2))
            rvalue = 1;
    }
    return rvalue;
}

void setupIO()
{
    RCC->AHBENR |= (1 << 18) + (1 << 17); // enable Ports A and B
    display_begin();
    pinMode(GPIOB,4,0);
    pinMode(GPIOB,5,0);
    pinMode(GPIOA,8,0);
    pinMode(GPIOA,11,0);
    enablePullUp(GPIOB,4);
    enablePullUp(GPIOB,5);  
    enablePullUp(GPIOA,11);
    enablePullUp(GPIOA,8);
}

void RockGen(uint16_t xRange, uint16_t yRange, uint16_t width, uint16_t height, const uint16_t rock[], uint16_t snailX, uint16_t snailY, uint16_t snailW, uint16_t snailH) {
    
    if (rock_hit || coin_collected) {
        return; //skip function if coin was collected or rock was hit
    }

    static uint16_t y = 5;
    static uint16_t randomNumber; 

    if (y == 5) {
        randomNumber = (rand() % (xRange - width)) + 1; //generate a random x value within the x range
    }

    putImage(randomNumber, y, 16, 16, rock, 0, 0); //print the rock
    delay(100); 
    fillRectangle(randomNumber, y, 16, 16, 0); //clear the rock off the screen

    if(isInside(snailX,snailY,(snailW + 2),snailH,(randomNumber + 2), y)) { //randomnumber+2 to improve hitbox size

        fillRectangle(snailX, snailY, snailW, snailH, 0);  // Clear snail
        rock_hit = true;  // Mark rock as hit

        // Update user lives
        if (lives > 1) {
            lives--;
            showHearts(lives);
            flashHeart(lives);
            putImage(snailX, snailY, 16, 16, Snail1, 0,0); //repaint snail
        } else {
            endGame(0);
        }

        y = 5;  // Reset rock to top of screen after hit
    } 

    //Different stages of rock falling speed as user collects more coins
    else if (coinCount <= 5) { 
        y += 8;
        if (y > yRange) {
            y = 5;
        }
    }
    else if (coinCount <= 10 && coinCount > 5) {
        y += 14;
        if (y > yRange) {
            y = 5;
        }
    }
    else if (coinCount < 15 && coinCount > 10) {
        y += 20;
        if (y > yRange) {
            y = 5;
        }
    }
    
}


void showHearts(uint16_t count) {
    // Display hearts based on lives count
    for (uint16_t i = 0; i < count; i++) {
        //painting hearts at different positions on the screen
        putImage(15 + (i * 18), 40, 16, 16, heart, 0, 0); 
    }
}

void endGame(uint16_t count) {

    fillRectangle(80, 64, 128, 160, 0); //blank screen
    printTextX2("Game Over", 15, 50, RGBToWord(0xff, 0x00, 0x00), 0);
    delay(1000);
    fillRectangle(0,0,128,160,0);
    menu();
}

void flashHeart(uint16_t count) {
    // Show and hide amount of hearts based on lives left 3 times
    for (int k = 0; k < 3; k++) {
        for (uint16_t i = 0; i < count; i++) {
            putImage(15 + (i * 18), 40, 16, 16, heart, 0, 0); // show heart
        }
        delay(250);
        for (uint16_t i = 0; i < count; i++) {
            fillRectangle(15 + (i * 18), 40, 16, 16, 0); // hide heart
        }
        delay(250);
    }
}

void coinGen(uint16_t count, uint16_t snailX, uint16_t snailY, uint16_t snailW, uint16_t snailH) {
    if (coin_collected || rock_hit) {
        return; // Skip if rock was hit or coin already collected
    }

    // Spawn coin on right or left based on last coin collected
    uint16_t coinX; 

    if (count % 2 == 0) {
        coinX = 10; // if count is odd coin spawns at x 10
    } else {
        coinX = 110; // otherwise, x 110
    }
    uint16_t coinY = 130;

    putImage(coinX, coinY, 16, 16, coin, 0, 0);

    if (isInside(snailX, snailY, snailW, snailH, coinX, coinY)) {
        coinCount++;
        coin_collected = true;  // Mark coin as collected
        fillRectangle(coinX, coinY, 16, 16, 0);  // Clear the coin 
    }
}

void menu(){

    fillRectangle(0, 0, 160, 128, 0); //clear screen

    //print sprites
    putImage(35, 90, 60, 16, finish1, 0, 0);
    putImage(35, 40, 60, 16, start1, 0, 0);
    

    while(1){
    if ( (GPIOA->IDR & (1 << 11)) == 0) // down pressed
		{
		    fillRectangle(35, 90, 60, 16, 0);
            putImage(35, 90, 60, 16, finish2, 0, 0); //highlight finish button
            delay(500);
            exit(0); //end game
		}
    
    if ( (GPIOA->IDR & (1 << 8)) == 0) // up pressed
		{   
            coinCount=0;
            lives = 3; //resent coin count and lives
            fillRectangle(35, 40, 60, 16, 0);
            putImage(35, 40, 60, 16, start2, 0, 0); //highlighted start button sprite
            delay(800);
            fillRectangle(35, 40, 60, 16, 0);
            fillRectangle(35, 90, 60, 16, 0);
            return;
		}
    
    }

}






